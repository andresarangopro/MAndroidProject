package com.lide.app.presenter;

import com.lide.app.MApplication;
import com.lide.app.listener.OnFinishListener;
import com.lide.app.persistence.util.SPUtils;
import com.lide.app.service.IScanService;
import com.lide.app.service.ScanServiceControl;
import com.lide.app.ui.VInterface.IDataFragmentView;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;

/**
 * Created by lubin on 2016/11/21.
 */

public class ScanPresenter {

    int num = 0;
    private static Map<String, String> map;
    private static List<String> out;

    IDataFragmentView view;
    private static Facility currentFacility = Facility.YBX;

    private IScanService mService = ScanServiceControl.getScanService();

    public static List<String> getOut() {
        return out;
    }

    public static Map<String, String> getMap() {
        return map;
    }

    public ScanPresenter(IDataFragmentView view) {
        this.view = view;
        map = new HashMap<>();
        out = new LinkedList<>();
    }

    public void initOut(List<String> datas) {
        out.addAll(datas);
    }

    public void initMap(List<String> datas) {
        for (String data : datas) {
            map.put(data, null);
            num++;
        }
    }

    public void initData() {
        num = 0;
        map.clear();
        out.clear();
    }

    public void setReadDataModel(int model) {
        mService.setReadDataMode(model);
    }

    public void setMode(int mode) {
        mService.setMode(mode);
    }

    public void initData(List<String> datas) {
        for (String data : datas) {
            map.put(data, null);
            num++;
        }
    }

    public void clearPartOfData(List<String> datas) {
        for (String data : datas) {
            map.remove(data);
            out.remove(data);
            num--;
        }
    }

    public void startReadRfid() {
        mService.startInventory();
    }

    public void stopReadRfid() {
        mService.stopInventory();
    }

    public void startScanBarcode() {
        mService.scanBarcode();
    }

    public void setCurrentSetting(Setting setting) {
        mService.setCurrentSetting(Setting.getSettingMap(setting));
    }

    public void setListener(OnFinishListener listener) {
        mService.setListener(listener);
    }

    public void removeListener() {
        mService.removeListener();
    }

    public void setListenerProtectModel(final OnFinishListener listener) {
        mService.setListener(new OnFinishListener() {
            @Override
            public void OnFinish(String data) {
                map.put(data, null);
                if (num < map.size()) {
                    num++;
                    out.add(data);
                    listener.OnFinish(data);
                }
            }
        });

    }

    public String searchNearestEpc(List<String> tags) {
        Map<Integer, String> treeMap = null;
        ArrayList<Integer> nums = null;
        try {
            treeMap = new TreeMap<>();
            nums = new ArrayList<>();
            for (String data : tags) {
                String[] split = data.split("@");
                String tag = split[0];
                int rssi;
                if (split.length > 1) {
                    rssi = Integer.parseInt(split[1]);
                } else continue;

                treeMap.put(rssi, tag);
                nums.add(rssi);
            }
            Collections.sort(nums, new Comparator<Integer>() {
                @Override
                public int compare(Integer lhs, Integer rhs) {
                    return rhs - lhs;
                }
            });

            return treeMap.get(nums.get(0));
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }

    public int getNum() {
        return num;
    }

    public enum Setting {

        binding, bindingMore, stockRead,;

        public static Map<String, Object> getSettingMap(Setting setting) {
            Map<String, Object> map = new HashMap<>();
            switch (setting) {
                case binding:
                    switch (currentFacility) {
                        case YBX:
                            map.put("power", SPUtils.get(MApplication.getInstance(), "power", 30));
                            break;
                        case CW:
                            map.put("power", 10);
                            break;
                    }
                    break;

                case bindingMore:
                    switch (currentFacility) {
                        case YBX:
                            map.put("power", SPUtils.get(MApplication.getInstance(), "power", 30));
                            break;
                        case CW:
                            map.put("power", 30);
                            break;
                    }
                    break;

                case stockRead:
                    switch (currentFacility) {
                        case YBX:
                            map.put("power", SPUtils.get(MApplication.getInstance(), "power", 30));
                            break;
                        case CW:
                            map.put("power", 30);
                            break;
                    }
                    break;

                default:

                    break;
            }
            return map;
        }
    }

    enum Facility {
        YBX, CW
    }
}
